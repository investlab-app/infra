# Application ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "investlab-backend.api.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.api.labels" . | nindent 4 }}
data:
  DATABASE_URL: {{ .Values.api.config.databaseUrl | quote }}
  REDIS_URL: {{ .Values.api.config.redisUrl | quote }}
  DJANGO_SETTINGS_MODULE: {{ .Values.api.config.djangoSettingsModule | quote }}
  DJANGO_LOG_LEVEL: {{ .Values.api.config.djangoLogLevel | quote }}
  ALLOWED_HOSTS: {{ .Values.api.config.allowedHosts | quote }}
  CORS_ALLOWED_ORIGINS: {{ .Values.api.config.corsAllowedOrigins | quote }}
  ENVIRONMENT: {{ .Values.api.config.environment | quote }}

---
# External Secrets Secret
{{- if .Values.secrets.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "investlab-backend-secrets.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.api.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.secrets.store }}
    kind: {{ .Values.secrets.storeKind }}
  target:
    name: {{ include "investlab-backend-secrets.fullname" . }}
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        DATABASE_PASSWORD: "{{ .databasePassword }}"
        CLERK_SECRET_KEY: "{{ .clerkSecretKey }}"
        POLYGON_SECRET_KEY: "{{ .polygonSecretKey }}"
        ALPACA_SECRET_KEY: "{{ .alpacaSecretKey }}"
        MINIO_ACCESS_KEY: "{{ .minioAccessKey }}"
        MINIO_SECRET_KEY: "{{ .minioSecretKey }}"
  data:
    - secretKey: password
      remoteRef:
        key: {{ .Values.secrets.postgresPasswordKey }}
    - secretKey: clerk-secret-key
      remoteRef:
        key: {{ .Values.secrets.clerkSecretKey }}
    - secretKey: polygon-secret-key
      remoteRef:
        key: {{ .Values.secrets.polygonSecretKey }}
    - secretKey: alpaca-secret-key
      remoteRef:
        key: {{ .Values.secrets.alpacaSecretKey }}
    - secretKey: minio-access-key
      remoteRef:
        key: {{ .Values.secrets.minioAccessKey }}
    - secretKey: minio-secret-key
      remoteRef:
        key: {{ .Values.secrets.minioSecretKey }}
{{- end }}

---
# Static files PVC
{{- if .Values.api.persistence.static.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "investlab-backend-pvc.fullname" . }}-static
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.api.labels" . | nindent 4 }}
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: {{ .Values.api.persistence.static.storageClass }}
  resources:
    requests:
      storage: {{ .Values.api.persistence.static.size }}
{{- end }}

---
# Media files PVC
{{- if .Values.api.persistence.media.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "investlab-backend-pvc.fullname" . }}-media
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.api.labels" . | nindent 4 }}
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: {{ .Values.api.persistence.media.storageClass }}
  resources:
    requests:
      storage: {{ .Values.api.persistence.media.size }}
{{- end }}

---
# HPA for API
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "investlab-backend.api.fullname" . }}-hpa
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.api.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "investlab-backend.api.fullname" . }}
  minReplicas: {{ .Values.autoscaling.api.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.api.maxReplicas }}
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.api.targetCPUUtilization }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.api.targetMemoryUtilization }}
{{- end }}

---
# HPA for Workers
{{- if and .Values.autoscaling.enabled .Values.worker.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "investlab-backend.worker.fullname" . }}-hpa
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.worker.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "investlab-backend.worker.fullname" . }}
  minReplicas: {{ .Values.autoscaling.worker.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.worker.maxReplicas }}
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.worker.targetCPUUtilization }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.worker.targetMemoryUtilization }}
{{- end }}

---
# Service Monitor
{{- if .Values.monitoring.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "investlab-backend.api.fullname" . }}-monitor
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-backend.api.labels" . | nindent 4 }}
    {{- with .Values.monitoring.serviceMonitor.labels }}{{- toYaml . | nindent 4 }}{{- end }}
spec:
  selector:
    matchLabels:
      {{- include "investlab-backend.api.selectorLabels" . | nindent 6 }}
  namespaceSelector:
    matchLabels:
      name: {{ .Values.monitoring.serviceMonitor.namespace }}
  ports:
  - port: http
    targetPort: 8000
    path: /metrics
{{- end }}