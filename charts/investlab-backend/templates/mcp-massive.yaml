{{- if and .Values.mcp.enabled .Values.mcp.massive.enabled -}}
# MCP Massive Service - Data visualization and analysis
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "investlab-mcp.massive.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "investlab-mcp.massive.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.mcp.massive.replicaCount }}
  selector:
    matchLabels:
      {{- include "investlab-mcp.massive.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "investlab-mcp.massive.labels" . | nindent 8 }}
    spec:
      endpoints:
        - path: /metrics
          port: http
          targetPort: 8000
      namespaceSelector:
        matchLabels:
          name: monitoring
      selector:
        matchLabels:
          app.kubernetes.io/component: api
          app.kubernetes.io/name: investlab-backend
          app.kubernetes.io/part-of: investlab
      containers:
      - name: massive
        image: {{ .Values.mcp.massive.image.registry }}/{{ .Values.mcp.massive.image.repository }}:{{ .Values.mcp.massive.image.tag | default "latest" }}
        imagePullPolicy: Always
        command:
          {{- toYaml .Values.mcp.massive.command | nindent 10 }}
        env:
          # Map POLYGON_SECRET_KEY from secrets to MASSIVE_API_KEY
          - name: MASSIVE_API_KEY
            valueFrom:
              secretKeyRef:
                name: {{ include "investlab-backend-secrets.fullname" . }}
                key: POLYGON_SECRET_KEY
        envFrom:
        - configMapRef:
            name: {{ include "investlab-mcp.massive.fullname" . }}-config
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP
        resources:
          {{- toYaml .Values.mcp.massive.resources | nindent 10 }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  {{- include "investlab-mcp.massive.selectorLabels" . | nindent 18 }}
              topologyKey: kubernetes.io/hostname
{{- end }}