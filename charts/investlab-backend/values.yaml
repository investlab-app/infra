# Global configuration
global:
  imageRegistry: ghcr.io
  imagePullSecrets:
    - name: ghcr-secret

# Database configuration
postgresql:
  enabled: true
  auth:
    enablePostgresPassword: true
    existingSecret: investlab-backend-investlab-backend-secrets
    existingSecretPasswordKey: password

# Redis configuration
redis:
  enabled: true
  auth:
    enabled: true
    existingSecret: redis-auth
  master:
    persistence:
      enabled: true
      size: 32Gi
      storageClass: oci-bv
    replica:
      replicaCount: 2
      persistence:
        enabled: true
        size: 32Gi
        storageClass: oci-bv

# Main Django API configuration
api:
  enabled: true
  replicaCount: 1
  image:
    repository: investlab-app/backend
    tag: latest
    pullPolicy: Always

  # Resource configuration
  resources:
    requests:
      memory: 512Mi
      cpu: 100m
    limits:
      memory: 1Gi
      cpu: 500m

  # Application configuration
  config:
    djangoLogLevel: INFO
    allowedHosts: "*"
    corsAllowedOrigins: https://api.investlab.kapica.click

  # Persistent storage
  persistence:
    static:
      enabled: true
      size: 5Gi
      storageClass: oci-bv
    media:
      enabled: true
      size: 10Gi
      storageClass: oci-bv

  # Health checks
  livenessProbe:
    httpGet:
      path: /api/status
      port: 8000
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /api/status
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Web Frontend configuration
web:
  enabled: true
  replicaCount: 1
  image:
    repository: investlab-app/web
    tag: latest
    pullPolicy: Always
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
    limits:
      memory: 256Mi
      cpu: 200m
  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 15
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Celery Worker configuration
worker:
  enabled: true
  replicaCount: 1
  command: ["uv", "run", "celery", "-A", "config", "worker", "-l", "info"]
  workingDir: /app

  resources:
    requests:
      memory: 512Mi
      cpu: 100m
    limits:
      memory: 2Gi
      cpu: 500m

# Celery Beat Scheduler configuration
scheduler:
  enabled: true
  replicaCount: 1
  command: ["uv", "run", "celery", "-A", "config", "beat", "-l", "info"]
  workingDir: /app

  resources:
    requests:
      memory: 256Mi
      cpu: 50m
    limits:
      memory: 512Mi
      cpu: 250m

# Price Stream Service configuration
priceStream:
  enabled: true
  replicaCount: 1
  command:
    [
      "sh",
      "-c",
      "printenv | sort; echo '---DEBUG ENV VARS---'; uv run manage.py mock_stream_prices",
    ]
  workingDir: /app

  resources:
    requests:
      memory: 512Mi
      cpu: 100m
    limits:
      memory: 1Gi
      cpu: 500m

# Price Notifier Service configuration
priceNotifier:
  enabled: true
  replicaCount: 1
  command: ["uv", "run", "manage.py", "notify_prices"]
  workingDir: /app

  resources:
    requests:
      memory: 256Mi
      cpu: 50m
    limits:
      memory: 512Mi
      cpu: 400m

# Order Engine Service configuration
orderEngine:
  enabled: true
  replicaCount: 1
  command: ["uv", "run", "manage.py", "run_order_engine"]
  workingDir: /app

  resources:
    requests:
      memory: 1Gi
      cpu: 100m
    limits:
      memory: 2Gi
      cpu: 1

# MCP Services configuration
mcp:
  enabled: true

  massive:
    enabled: true
    replicaCount: 1
    image:
      registry: ghcr.io
      repository: astral-sh/uv
      tag: debian
    command:
      - uvx
      - --from
      - git+https://github.com/investlab-app/mcp_massive
      - mcp_massive
    # Environment configuration
    logLevel: INFO
    port: "8000"
    transport: streamable-http # Added
    host: "0.0.0.0" # Added
    resources:
      requests:
        memory: 512Mi
        cpu: 200m
      limits:
        memory: 1Gi
        cpu: 500m

  echarts:
    enabled: true
    replicaCount: 1
    image:
      registry: mirror.gcr.io/library
      repository: node
      tag: 22-alpine
    command: ["/bin/sh", "-c", "npx -y mcp-echarts -t streamable --port 8000"]
    ports:
      - port: 8051
    # Configuration values
    logLevel: INFO
    port: "8000"
    nodeEnv: production
    resources:
      requests:
        memory: 256Mi
        cpu: 200m
      limits:
        memory: 512Mi
        cpu: 400m
    minio:
      endpoint: "minio.example.com"
      port: 9000
      useSsl: true
      bucketName: "echarts"

# Service configuration
service:
  type: ClusterIP
  annotations: {}

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: 50m
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/cors-allow-origin: https://api.investlab.kapica.click
    nginx.ingress.kubernetes.io/cors-allow-methods: GET, POST, PUT, DELETE, OPTIONS
    nginx.ingress.kubernetes.io/cors-allow-headers: DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization
  tls:
    - hosts:
        - api.investlab.kapica.click
        - investlab.kapica.click
      secretName: investlab-backend-tls
  hosts:
    - host: api.investlab.kapica.click
      paths:
        - path: /api
          service: api
          port: 8000
        - path: /admin
          service: api
          port: 8000
        - path: /static
          service: api
          port: 8000
        - path: /media
          service: api
          port: 8000
        - path: /mcp/massive
          service: mcp-massive
          port: 8050
        - path: /mcp/echarts
          service: mcp-echarts
          port: 8051
    - host: investlab.kapica.click
      paths:
        - path: /api
          service: api
          port: 8000
        - path: /admin
          service: api
          port: 8000
        - path: /static
          service: api
          port: 8000
        - path: /media
          service: api
          port: 8000
        - path: /ws
          service: api
          port: 8000
        - path: /
          service: web
          port: 80

# Auto-scaling configuration
autoscaling:
  enabled: true
  api:
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilization: 70
    targetMemoryUtilization: 80
  worker:
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilization: 70
    targetMemoryUtilization: 80

# Monitoring configuration
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring
    labels:
      release: prometheus

# Network policies
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              name: web
        - namespaceSelector:
            matchLabels:
              name: backend
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: postgres
        - namespaceSelector:
            matchLabels:
              name: redis
